##第五章 FX衍生品

FX衍生品（或外汇衍生品）是金融衍生产品，它的结算方法是两种（或多种）货币汇率的一个函数。和一般的衍生品一样，FX衍生品可以分成三个主要的类型：期货、互换和期权。在本章中，我们只处理期权类型的衍生品。我们从基本的Black-Scholes模型的一个直接的一般化开始，并展示如何对一个简单的欧式看涨或看跌货币期权定价。之后，我们会讨论汇率期权和汇率联动期权（quanto options）的定价。

对于本章内容，我们假设你具有衍生品定价特别是Black-Scholes模型和风险中性估值的基础知识。偶尔地，我们会涉及某些经常用于数量金融的数学关系（比如伊藤引理（Itô's lemma）或吉尔萨诺夫定理（Girsanov theorem）），但是对这些定理的深入理解并非本章所必需的。然而，对于那些对这个主题的纯数学背景感兴趣的读者可以查阅Medvegyev (2007)。

###5.1 术语和记号

既然我们要处理汇率，说明某些相关术语是很重要的。通常，我们用$S$代表现货汇率，它衡量的是一种货币（称为基础货币）以另一种货币（称为变量或报价货币）为单位的价格。换句话说，一单位的基础货币等于$S$单位的变量货币。理解如何阅读外汇市场报价也是很重要的。关于一个货币对的汇率报价是由两种货币的缩写表示的：一个三字母的代码表示基础货币，接下来另一个三字母代码表示变量货币。例如，EURUSD=1.25意味着1欧元价值1.25美元。这相当于报价USDEUR=0.8，意味着1美元价值0.8欧元。通常，依靠历史形成的市场管理来决定在给定的外汇对中哪种货币会作为基础货币。

在第四章“大数据——高等分析”中，我们已经看到如何从互联网下载货币汇率数据。所以我们可以利用所学的内容在真实数据上进行检查。

下面这组段代码画出了在相同时间窗口EURUSD和USDEUR的汇率：
```
library(Quandl)
library(xts)
EURUSD <- Quandl("QUANDL/EURUSD",
start_date="2014-01-01",end_date="2014-07-01", type="xts")
USDEUR <- Quandl("QUANDL/USDEUR",
start_date="2014-01-01",end_date="2014-07-01", type="xts")
dev.new(width = 15, height = 8)
par(mfrow = c(1, 2))
plot(USDEUR)
plot(EURUSD)
```
这里，我们能在下面图像看到结果：
![Alt text](1466167747635.png)
图5-1
我们可以检查数据的开头几列：
```
USDEUR[1:5,]
Rate High (est) Low (est)
2014-01-01 0.725711 0.73392 0.71760
2014-01-02 0.725238 0.73332 0.71725
2014-01-03 0.727714 0.73661 0.71892
2014-01-06 0.733192 0.00000 0.00000
2014-01-07 0.735418 0.00000 0.00000
EURUSD[1:5,]
Rate High (est) Low (est)
2014-01-01 1.37791 0.0000 0.0000
2014-01-02 1.37876 1.3949 1.3628
2014-01-03 1.37434 0.0000 0.0000
2014-01-06 1.36346 1.3799 1.3473
2014-01-07 1.35990 1.3753 1.3447
```
在这里，我们得说一下关于记号的事情。到目前为止，我们用$S$表示了汇率。然而，衍生品定价当中基础资产的价格一般也记为$S$，无论它是股票还是货币。另一方面，汇率会被记为$X$或者有时记为$E$（都来源于单词“exchange”）。更进一步地，期权的协议价格或执行价格也缩写为$X$或$E$。现在，作为读者你可能有点理解在本章中使用一致的符号系统，是一件多么有挑战的事情。在这里基础产品可能是股票也可能是货币，而且股票价格、汇率和协议价格可能同时出现。我们决定尽可能地采用R函数的记号，所以在本章中，我们所用的记号如下：
- 基础产品的价格一直会用$S$，但这并不必然对应货币。对于货币，我们会使用数值或字母的下标如$S_{1}$或$S_A{}$
-协议价格总会用$X$
-期望值算子会记为$E$

我们强烈建议当你阅读这一主题的其他文献时要格外小心，因为他们的记号可能和我们不同。

###5.2 货币期权

欧式货币期权赋予持有者一种权利，可以在指定的时刻（到期日，$T$）以预定的汇率（协议价格或执行价格，$X$），买入（看涨期权）或卖出（看跌期权）货币。这种金融资产也叫外汇期权（或FX期权），但为了避免和术语“交换期权”混淆，我们更喜欢“货币期权”这个术语。
（译者注：相关英文术语
货币期权：currency option
外汇期权：foreign exchange option
交换期权：exchange option）

原始的Black-Scholes模型（Black and Sholes, 1973,也可参见Merton, 1973）的一个基本假设是基础产品是不支付红利的股票。更一般地，模型结果只有在基础产品不获得任何形式的收益或者不产生任何形式的成本时才是成立的。这个假设是容易放松的，而且扩展版本的Black-Scholes公式对于货币期权也有效，同时模型的所有逻辑和论证无需改变。

欧式货币看涨期权价格$$闭合形式的公式如下：
$$$$

上面公式中，$d_{1}$和$d_{2}$的值如下：
$$$$

上面公式中$S_{0}$是现货汇率（由变量货币表示的，一单位基础货币的价格），$X$是协议价格，$T$是距离期权到期日的时间（单位为年），$\sigma$是汇率的波动率，而$N$代表标准正态分布的累积分布函数。由看跌-看涨平价很容易看出带有同样参数的欧式看跌货币期权的价格（$$）如下：
$$$$

在fOptions包里提供了Black-Scholes公式和其他的期权定价模型。我们可以用BlackScholesOption或者GBSOption函数，它们几乎是相同的，后者是前者的简写别名。
```
BlackScholesOption(TypeFlag, S, X, Time, r, b, sigma,...)
```
这里，TypeFlag可以是字符c表示看涨期权，也可以是p表示看跌期权。S是当前价格，sigma是基础产品的波动率，X是协议价格，T是距离到期日的时间。另两个参数稍有点复杂，r和b都是无风险利率，但当利用原始BS模型定价股票期权时，第二个参数b是无意义的。这表明为了得到BS股票期权模型，我们必须设置b=r，而为了得到货币期权或带有连续红利收益的股票期权模型要设置b=r-q。这个函数的其他参数是可选的，我们并不需要它们。

为了看到它如何发挥作用，假定我们有一个期限为5年的欧元（EUR）期权，协议价格为0.7。美元（USD）的无风险利率是r = 3%而欧元的无风险利率是r = 2%。1美元目前等于0.7450欧元，这就是基础资产的现货价格。设欧元波动率为20%。如果调用带有给定参数的 BlackSholesOption函数，我们得到下面的结果：
```
BlackScholesOption ("c", 0.7450, 0.7, 5, 0.03, 0.01, 0.2)
Title:
Black Scholes Option Valuation
Call:
GBSOption(TypeFlag = "c", S = 0.745, X = 0.7, Time = 5, r = 0.03,
b = 0.01, sigma = 0.2)
Parameters:
Value:
TypeFlag c
S 0.745
X 0.7
Time 5
r 0.03
b 0.01
sigma 0.2
Option Price:
0.152222
Description:
Thu Aug 07 20:13:28 2014
```
还可以检查看跌期权的价格：
```
BlackScholesOption("p", 0.7450, 0.7, 5, 0.03, 0.01, 0.2)
Title:
Black Scholes Option Valuation
Call:
GBSOption(TypeFlag = "p", S = 0.745, X = 0.7, Time = 5, r = 0.03,
b = 0.01, sigma = 0.2)
Parameters:
Value:
TypeFlag p
S 0.745
X 0.7
Time 5
r 0.03
b 0.01
sigma 0.2
Option Price:
0.08061367
Description:
Thu Aug 07 20:15:11 2014
```
然后，还可以检查看跌-看涨平价的一致性，对于货币期权它采用下面的形式：
$$  $$
代入数据，我们得到左侧的值：
```
c - p = 0.152222 - 0.08061367 = 0.07160833
```
右侧的值：
```
0.745*exp(-0.02*5)-0.7*exp(-0.03*5) = 0.07160829
```
小提示
期权价格被保留到小数点后8位，所以左右两边有点轻微的差异。

很重要的一点是要注意定价一个货币期权和定价任意一种可获得连续收益的基础资产的期权是等价的。比如，如果基础资产是年股息率为q的股票或股票指数，定价公式和上面提到的公式是相同。

###5.3 交换期权

交换期权赋予持有者在到期时刻将一种风险资产和另一种风险资产进行交换的权利。容易看出简单期权是交换期权的一种特殊形式，它的一种风险资产是固定数目的资金（和执行价格的金额相同）。

交换期权的定价公式最早是由Margrabe, 1978导出的。Margrabe的模型假设、定价原则以及由此而得到的公式和Black，Scholes，Merton模型的相关内容是非常相似的（更准确一点说，是一种一般化）。

定义时刻$t$两种风险资产的现货价格为$S_{1t}$和$S_{1t}$。假设风险中性测度（$Q$）下的价格服从漂移项等于风险中性利率（$r$）的几何布朗运动，表现为：
$$和$$
这里，$W_{1}$和$W_{2}$是$Q$之下的标准维纳过程，相关系数为$rho$。你可以观察到在这里，资产没有收益（比如，股票没有支付红利）。众所周知（而且由伊藤引理容易看出）前面提到的随机微分方程的解为：
$$和 （1）$$

我们假定你熟悉基本的一维随机过程。然而，在交换期权的情形下，要用到二维维纳过程，因此显示它的形式是有用的。

####5.3.1 二维维纳过程

2D维纳过程类似二维的连续时间的随机行走。我们可以只用几行代码就能轻松生成这样一个过程当坐标是独立的维纳过程（别用放缩过程来烦我们因为它看起来是一样的）。
```
D2_Wiener <- function() {
dev.new(width = 10, height = 4)
par(mfrow = c(1, 3), oma = c(0, 0, 2, 0))
for(i in 1:3) {
W1 <- cumsum(rnorm(100000))
W2 <- cumsum(rnorm(100000))
plot(W1,W2, type= "l", ylab = "", xlab = "")
}
mtext("2-dimensional Wiener-processes with no correlation",
outer = TRUE, cex = 1.5, line = -1)
}
```
如果调用这个函数，输出大约是这样的：
```
D2_Wiener()
```
在这里，看到结果在下面的图像中：
![Alt text](1466236118583.png)

维纳过程之间的相关系数会引人注目地改变这个图形。在正相关的情形下，这两个维纳过程看起来像是同方向运动；在负相关的情形下，它们看起来是在向相反的方向运动。

我们可以修正这个函数来获得相关的维纳过程。容易看出下面的代码完成了这项工作：
```
Correlated_Wiener <- function(cor) {
dev.new(width = 10, height = 4)
par(mfrow = c(1, 3), oma = c(0, 0, 2, 0))
for(i in 1:3) {
W1 <- cumsum(rnorm(100000))
W2 <- cumsum(rnorm(100000))
W3 <- cor * W1 + sqrt(1 - cor^2) * W2
plot(W1, W3, type= "l", ylab = "", xlab = "")
}
mtext(paste("2-dimensional Wiener-processes (",cor," correlation)",
sep = ""), outer = TRUE, cex = 1.5, line = -1)
}
```
在前面的例子里，我们把相关系数设置为0.6,。现在看一下，如果相关系数是-0.7会发生什么：
```
Correlated_Wiener(-0.7)
```
这里，在下面的图形中能看到结果：
![Alt text](1466329876998.png)
可以清楚地看到使用不同的相关系数时过程之间的区别。现在，我们把注意力转回到交换期权上。

####5.3.2 Margrabe公式

交换期权在到期时的支付$H_{T}$由$ $定义。根据基本的风险中性定价原则，这个支付的值（或者等价的，交换期权的价格，记作$\pi(H_{T})$）如下：
$$ (2)$$

在方程（2）中，$S_{t}$（没有下标1或2）定义为商$ $。换句话说，$S$是以$S_{2}$为单位的$S_{1}$的价格。如果这两种风险资产是两种货币的话，$S$就是汇率，这也就是我们采用这种记号的原因。

为了计算前面提到的期望值，我们需要引入一个新的测度（$R$）,由下面的Radon-Nikodym导数定义：
$$    $$
在这，上面公式右侧来自于对$S_{2}$应用方程（1）的结果。

然后，交换期权的价格可以采用下面的形式：
$$   （3）  $$

现在，我们需要决定在$R$之下$S$服从什么样的过程。由吉尔萨诺夫定理，我们知道$ $和$ $是在$R$之下是维纳过程，而且它们的相关系数依然是$\rho$。我们引入下列记号：
$$ $$
$$ $$
根据Lévy的描述，我们知道$W$是$R$之下的维纳过程。现在可以决定S满足的方程：
$$ $$
这意味着在$R$之下，S是一个带零漂移的几何布朗运动，即$ $。

现在，如果你还记得，在方程（3）当中，交换期权的价格满足下面的方程：
$$  $$

对$S$应用这种关系,等式右侧的期望值仅是基础资产$S$的看涨期权的值，其中$r$等于0，$X$等于1。简单地使用$c_{0}$代表这个看涨期权的价格。那么$ $。

这里，$ $可能会借助基本的Black-Scholes公式来决定，其中的参数由我们刚刚讨论的那些来代替：
$$ $$

这里$ $，
其中$ $和$ $

前面提到过的$ $的公式，是交换期权的定价公式，叫做Margrabe公式。如果有连续红利收益，可能会如同Black-Scholes公式的情形一样简单地插入公式中。我们仅给出这种情况的结果，不再重复这个计算。

那么，假设要交换的风险资产有分别表示为$ $和$ $的正连续红利收益。对这种情况，它们在测度$Q$之下的价格过程如下：
$$ $$

此时，Margrabe公式会取下面的形式：
$$ $$

这里，$ $和$ $

#### 3.3.3 在R中应用

对于Margrabe公式，R没有内置的函数。然而，比实现结果更难的是理解这个公式背后的复杂理论。在这里，我们表达Margrabe函数只用了几行，基于显示在下面代码中的参数计算的交换期权的价格。
```
Margrabe <- function(S1, S2, sigma1, sigma2, Time, rho, delta1 = 0,
delta2 = 0) {
sigma <- sqrt(sigma1^2 + sigma2^2 - 2 * sigma1 * sigma2 * rho)
d1 <- ( log(S1/S2) + ( delta2-delta1 + sigma^2/2 ) * Time ) /
(sigma*sqrt(Time))
d2 <- ( log(S1/S2) + ( delta2-delta1 - sigma^2/2 ) * Time ) /
(sigma*sqrt(Time))
M <- S1*exp(-delta1*Time)*pnorm(d1) - S2*exp(-delta2*Time)*pnorm(d2)
return(M)
}
```
这是函数的核心部分。如果我们的要求更高或者想要发展一个用户友好的应用，需要找出可能的错误和例外情况。比如，应该包括一些类似这样的语句：
```
if min(S1, S2) <= 0) stop("prices must be positive")
```
如果波动率是负的，执行也应该停止，但用户体验和相关的软件设计超过了本书的范围。我们可以使用这个函数结合有效的参数来看一个说明它工作原理的例子。比如说，我们有两个不支付红利的风险资产，一个的价格为100美元波动率为20%，另一个的价格为120美元波动率为30%，期限为两年。首先，取相关系数为15%。

调用带有给定参数的Margrabe函数：
```
Margrabe(100, 120, .2, .3, 2, .15)
[1] 12.05247
```
结果是12美元。现在如果一个资产是无风险的，即，波动率为0，我们来看看会发生什么。调用带有下列参数的函数：
```
Margrabe(100, 120, .2, 0, 2, 0, 0, 0.03)
[1] 6.566047
```
这意味着什么？这个产品赋予我们的权利是，用第一项价值100美元带有20%波动率的有风险资产，交换第二项“风险”资产，这个资产的价格为120美元，支付3%的红利，波动率为0，（所以它是一个固定的现金数目）利率为3%。特别的，在两年当中，它会是这样一种权利，当无风险利率3%时用120美元买入股票。我们来比较一下这个价格和该看涨期权的BS价格：
```
BlackScholesOption("c", 100, 120, 2, 0.03, 0.03, .2)
Title:
Black Scholes Option Valuation
Call:
GBSOption(TypeFlag = "c", S = 100, X = 120, Time = 2, r = 0.03,
b = 0.03, sigma = 0.2)
Parameters:
Value:
TypeFlag c
S 100
X 120
Time 2
r 0.03
b 0.03
sigma 0.2
Option Price:
6.566058
Description:
Tue Aug 05 11:29:57 2014
```
是的，它们确实是一样的。如果我们设置第一项资产的波动率为0。这在实际上意味着我们有了第二项资产的看跌期权。
```
Margrabe(100, 120, 0, 0.2, 2, 0, 0.03, 0)
[1] 3.247161
```
BS公式的结果如下：
```
BlackScholesOption("p", 120, 100, 2, 0.03, 0.03, .2)
Title:
Black Scholes Option Valuation
Call:
GBSOption(TypeFlag = "p", S = 120, X = 100, Time = 2, r = 0.03,
b = 0.03, sigma = 0.2)
Parameters:
Value:
TypeFlag p
S 120
X 100
Time 2
r 0.03
b 0.03
sigma 0.2
Option Price:
3.247153
Description:
Fri Aug 08 17:38:04 2014
```
这两个例子中，只在小数点后第五位起有数值误差。

我们也可以用Margrabe公式得到我们在“货币期权”这一节讨论过的货币期权的价格。可以检查BS公式是否提供了相同的价格：
```
Margrabe(0.745, 0.7, 0.2, 0, 5, 0.15, 0.02, 0.03)
[1] 0.152222
```
我们需要讨论的最后一件事是相关系数是如何影响期权价格的。为了说明这一点，我们用不同的相关系数的值计算期权的Margrabe价格。这可以由几行代码完成：
```
x <- seq(-1, 1, length = 1000)
y <- rep(0, 1000)
for (i in 1:1000)
y[i] <- Margrabe(100, 120, .2, 0.3, 2, x[i])
plot(x, y, xlab = "correlation", ylab = "price",
main = "Price of exchange option", type = "l", lwd = 3)
```
在这里，能在下面的图像中看到结果：
![Alt text](1466648653482.png)
图

结果并不出人意料。当相关系数取值很高时，我们有权力在相同的股票之间进行转换，很明显，这种权利是没有价值的。当相关系数的取值在负的一边很高时，如果事情变坏，我们就有了更好的机会利用这个期权做一笔好交易（这意味着负的相关系数越高，若我们的资产下跌，另一项资产价格上涨并且挽回我们损失的机会就越大）。换句话说，在这种情况下，期权与其说是投机不如说是保险。我们并不需要恐惧来自另一项资产价格改变的风险。这就是为什么当相关系数为负时期权更有价值。

### 5.4 Quanto期权
术语“Quanto”来自于“quantity adjusting option”的缩写。quanto衍生品的结算由用一种货币表示的资产决定，但由另一种货币偿付。

理解quanto产品（或任何类型的衍生品）的最佳方法是检查它的结算函数。众所周知的是假设基础资产是不支付红利的股票，欧式看涨期权的结算公式如下：
$$ $$
这里$S_{A}$是股票的价格而$X$是执行价格。在这里，$ $、$ $和$X$是用同一种货币表示的，我们称之为本币。

欧式看涨quanto的结算如下：

这里$S$是外币汇率。于是，一个看涨quanto支付和简单看涨期权一样“数量”的金钱，但是使用另一种货币——我们称之为外币。所以，这个数量的支付需要乘以汇率得到用本币表示的损益值。当然，$S$是根据本币得到的外币价格。换句话说，在$S$的报价中，基础货币是外币。

#### 5.4.1 看涨quanto的定价公式

定价看涨quanto意味着决定上面公式中损益的价值。和通常一样，我们假设在风险中性测度$Q$之下的基础资产价格服从几何布朗运动，漂移率等于无风险的本币利率$r$，即，
$$ $$
更进一步地，假设汇率服从一个类似的过程：
$$  $$

在这些公式中，$ $和$ $是Q之下标准的维纳过程，相关系数为$\rho$。记$q$表示无风险外币利率。这意味着在时刻$t$一单位的外国银行存款的价值为$ $。根据本币，这个价值的表示如下：
$$ $$
假如这是一种本国市场上交易的产品，在$Q$之下它的折现值是一个鞅。来计算这个折现值：
$$ $$
当且仅当$\mu=r-q$时，这个过程是$Q$下的鞅。现在计算乘积$SS_{A}$，我们把它记为$Y$:
$$ $$
$ $和$ $的相关系数$ $是$ $。
这样，$ $。

现在，重要的是注意到看涨quanto是一种特殊的交换期权，因此，可能由Margrabe公式来定价。我们只需要在行使期权的时候识别两种有风险资产，以及相关的参数。从quanto的损益函数，容易看出第一项风险资产是$ $，而第二项是$XS$（都用本币表示）。因为在$Q$之下这些过程的漂移成分并非仅仅是本币的无风险利率，我们需要使用带有红利收益的Margrabe公式。根据之前的计算，we can see that the Y process should be handled as if the dividend yield was
− −   1 2 q r , while in case of XS, it is simply q.唯一留待决定的参数是$\sigma$。利用直接代换，我们得到下面的计算式：
$$ $$
概括所有这些结果，我们需要用Margrabe公式（在公式（4）中给定）并进行替换$ $。

因此，看涨quanto的价格如下：
$$ $$
在上面的公式中，$ $和$ $如下：

####5.4.2 在R中定价看涨quanto 

我们来看一个在R中定价看涨quanto的例子。中意的股票价格为100美元波动率为20%。我们需要一个90美元的看涨期权，用欧元支付期限三年。美元的无风险利率是$r=2%$，欧元的无风险利率是$q=3%$。当前，1美元等于0.7467欧元。欧元波动率是15%，股票价格与美元兑欧元汇率的相关系数是10%。

如果在三年内股票的价格超过了90美元，价差按欧元支付。比如，如果三年内的价格是110美元，我们会得到20欧元。按照当前的汇率，这就是$ $，但是如果欧元兑美元的汇率在三年内发生了变化，例如美元兑欧元等于0.7，这个值就等于28.57143。所以损益与按美元计价的方式不同，但是如果希望按欧元支付，我们忽略了汇率风险。

这看起来挺麻烦，但幸运的是，我们可以使用Margrabe公式和我们编写的Margrabe函数来计算期权的价格。
```
Margrabe = function(S1, S2, sigma1, sigma2, Time, rho, delta1 = 0, delta2
= 0)
```
需要一些替换$ $。
$S_{1}$是用欧元表示的股票价格，$S_{2}$是用欧元表示的执行价格。$ $和$ $容易计算得到：$ $。唯一的问题是我们需要设置$ $，但$ $并非Margrabe函数的参数。它是在函数体当中计算的。考虑下列命令：
```
sigma = sqrt(sigma1^2 + sigma2^2 - 2 * sigma1 * sigma2 * rho)
```
为得到$ $的结果，我们需要设置$ $。

现在，我们可以调用带有给定参数的Margrabe函数：
```
Margrabe(74.67, 90*0.7467, 0.2, 0,3, 0, 0.007 , 0.03)
[1] 16.23238
```
结果是16.23，这就是quanto的价格。

### 5.5 小结

在本章中，我们遇到的挑战是金融数学中最优美也是最困难的部分之一：衍生品定价。从理论上和实践上，我们学习对于相关问题的Black-Scholes模型的一般化。我们学习如何对货币期权使用R和Black-Scholes公式。我们看到了对Margrabe公式实现我们自己的代码是如何简单。我们使用这个公式定价股票期权、货币期权和交换期权。最后，我们讨论了quanto期权并且了解了quanto同样可以使用Margrabe公式定价。

如果你发现这一章令人兴奋，那你会对下一章非常有兴趣，它涉及一个相关的主题，那就是汇率衍生品。

### 参考文献

- Black, F. and Scholes, M. (1973): The Pricing of Options and Corporate
Liabilities. The Journal of Political Economy, 81(3), pp. 637-654.
- Margrabe, W. (1978): The Value of an Option to Exchange One Asset
for Another. Journal of Finance, 33(1), pp. 177-186.
- Medvegyev, Péter (2007): Stochastic Integration Theory. Oxford
University Press.
• Merton, R. (1973): Theory of Rational Option Pricing. The Bell Journal of
Economics and Management Science, 4(1), pp. 141-183.


一些术语问题：（参考期权、期货和其他衍生产品，中文第8版）
payoff : 回报（到期日结算的损益）
maturity data : 满期日
strike price: 敲定价格
